<!DOCTYPE html>
<html>
<head>
  <title>ã²ã¿ã¤ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªğŸ“¬</title>
  <meta charset="UTF-8">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1em; }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; }
    button { padding: 8px 12px; margin-right: 5px; }
    .msg { border: 1px solid #ccc; margin: 8px 0; padding: 8px; border-radius: 8px; }
    .read { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªğŸ“¬</h1>

  <h3>ã‚ãªãŸã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰</h3>
  <input id="myAddress" placeholder="ä¾‹: apple123">
  <button onclick="loadMessages()">ğŸ“¥ ãƒ¡ãƒ¼ãƒ«èª­ã¿è¾¼ã¿</button>

  <hr>
  <h3>âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡</h3>
  å®›å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š<input id="to">
  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š<textarea id="msg"></textarea>
  <button onclick="send()">é€ä¿¡</button>

  <hr>
  <h3>ğŸ“¨ å—ä¿¡ãƒœãƒƒã‚¯ã‚¹</h3>
  <div id="inbox"></div>

  <hr>
  <h3>ğŸ“© è¿”ä¿¡</h3>
  å®›å…ˆ: <input id="replyTo">
  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: <textarea id="replyText"></textarea>
  <button onclick="sendReply()">è¿”ä¿¡</button>

  <script>
    // ğŸ”§ Firebaseã®è¨­å®šï¼ˆè‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã«ç½®ãæ›ãˆã¦ã­ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyARKS33U4ZxQQv2qK3yJgd9CUPyJy0ldBI",
      authDomain: "messeji-app-98931.firebaseapp.com",
      databaseURL: "https://messeji-app-98931.firebaseio.com",
      projectId: "messeji-app-98931",
      storageBucket: "messeji-app-98931.firebasestorage.app",
      messagingSenderId: "51810179187",
      appId: "1:51810179187:web:c6dd19a86563faa4da7206"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function send() {
      const from = document.getElementById("myAddress").value;
      const to = document.getElementById("to").value;
      const text = document.getElementById("msg").value;
      db.ref("messages/" + to).push({
        from: from,
        text: text,
        time: new Date().toISOString(),
        read: false
      }).then(() => {
        alert("é€ä¿¡å®Œäº†ï¼");
        document.getElementById("msg").value = "";
      });
    }

    function loadMessages() {
      const addr = document.getElementById("myAddress").value;
      const inbox = document.getElementById("inbox");
      inbox.innerHTML = "";

      db.ref("messages/" + addr).on("value", (snapshot) => {
        inbox.innerHTML = "";
        const data = snapshot.val();
        if (!data) {
          inbox.innerHTML = "<p>ğŸ“­ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã å±Šã„ã¦ã„ã¾ã›ã‚“</p>";
          return;
        }

        Object.entries(data).forEach(([id, msg]) => {
          const div = document.createElement("div");
          div.className = "msg" + (msg.read ? " read" : "");

          div.innerHTML = `
            <b>From:</b> ${msg.from}<br>
            <b>æ™‚é–“:</b> ${new Date(msg.time).toLocaleString()}<br>
            <p>${msg.text}</p>
            <button onclick="markRead('${addr}', '${id}')">âœ… æ—¢èª­</button>
            <button onclick="deleteMsg('${addr}', '${id}')">ğŸ—‘ å‰Šé™¤</button>
            <button onclick="prepareReply('${msg.from}')">ğŸ“© è¿”ä¿¡</button>
          `;

          inbox.appendChild(div);
        });
      });
    }

    function markRead(addr, id) {
      db.ref(`messages/${addr}/${id}`).update({ read: true });
    }

    function deleteMsg(addr, id) {
      db.ref(`messages/${addr}/${id}`).remove();
    }

    function prepareReply(to) {
      document.getElementById("replyTo").value = to;
      document.getElementById("replyText").focus();
    }

    function sendReply() {
      const from = document.getElementById("myAddress").value;
      const to = document.getElementById("replyTo").value;
      const text = document.getElementById("replyText").value;
      db.ref("messages/" + to).push({
        from: from,
        text: text,
        time: new Date().toISOString(),
        read: false
      }).then(() => {
        alert("è¿”ä¿¡é€ã£ãŸã‚ˆï¼");
        document.getElementById("replyText").value = "";
      });
    }
  </script>
</body>
</html>
